trigger:
- master
- release/*
- internal/release/3.*

variables:
  - name: _TeamName
    value: Roslyn-Project-System
  - name: _DotNetArtifactsCategory
    value: .NETCore
  - ${{ if eq(variables['System.TeamProject'], 'public') }}:
    - name: _DotNetPublishToBlobFeed
      value: false
    - name: _PublishUsingPipelines
      value: false
    - name: _SignType
      value: test
    - name: _InternalRuntimeDownloadArgs
      value: ''
  - ${{ if ne(variables['System.TeamProject'], 'public') }}:
    - name: _DotNetPublishToBlobUrl
      value: https://dotnetfeed.blob.core.windows.net/dotnet-core/index.json
    - name: _DotNetPublishToBlobFeed
      value: true
    - name: _PublishUsingPipelines
      value: true
    - name: _SignType
      value: real
    - group: DotNet-MSRC-Storage
    - name: _InternalRuntimeDownloadArgs
      value: /p:DotNetRuntimeSourceFeed=https://dotnetclimsrc.blob.core.windows.net/dotnet
             /p:DotNetRuntimeSourceFeedKey=$(dotnetclimsrc-read-sas-token-base64)
  - ${{ if and(ne(variables['System.TeamProject'], 'public'), notin(variables['Build.Reason'], 'PullRequest')) }}:
    - group: DotNet-CLI-SDLValidation-Params


stages:
- stage: build
  displayName: Build
  jobs:
  - template: /eng/build.yml
    parameters:
      agentOs: Windows_NT
      pool:
        ${{ if eq(variables['System.TeamProject'], 'public') }}:
          name: NetCorePublic-Pool
          queue: buildpool.windows.10.amd64.vs2017.open
        ${{ if ne(variables['System.TeamProject'], 'public') }}:
          name: NetCoreInternal-Pool
          queue: buildpool.windows.10.amd64.vs2017
      timeoutInMinutes: 180
      strategy:
        matrix:
          ${{ if eq(variables['System.TeamProject'], 'public') }}:
            Build_Debug_x86:
              _BuildConfig: Debug
              _BuildArchitecture: x86
              _DOTNET_CLI_UI_LANGUAGE: ''
              _DropSuffix: ''
            Build_ES_Debug_x64:
              _BuildConfig: Debug
              _BuildArchitecture: x64
              _DOTNET_CLI_UI_LANGUAGE: es
              _DropSuffix: ''
            Build_DropSuffix_Release_x64:
              _BuildConfig: Release
              _BuildArchitecture: x64
              _DOTNET_CLI_UI_LANGUAGE: ''
              _DropSuffix: true
          Build_Release_x64:
            _BuildConfig: Release
            _BuildArchitecture: x64
            _DOTNET_CLI_UI_LANGUAGE: ''
            _DropSuffix: ''

  - ${{ if eq(variables['System.TeamProject'], 'public') }}:
    - template: /eng/build.yml
      parameters:
        agentOs: Linux
        pool:
          name: Hosted Ubuntu 1604
        timeoutInMinutes: 180
        strategy:
          matrix:
            Build_Ubuntu_14_04_Release_x64:
              _BuildConfig: Release
              _DockerParameter: '--docker ubuntu.14.04'
              _LinuxPortable: ''
              _RuntimeIdentifier: ''
              _BuildArchitecture: 'x64'
              _DropSuffix: ''
            Build_Ubuntu_16_04_Debug_x64:
              _BuildConfig: Debug
              _DockerParameter: '--docker ubuntu.16.04'
              _LinuxPortable: ''
              _RuntimeIdentifier: ''
              _BuildArchitecture: 'x64'
              _DropSuffix: ''
            Build_Ubuntu_18_04_Debug_x64:
              _BuildConfig: Debug
              _DockerParameter: '--docker ubuntu.18.04'
              _LinuxPortable: '--linux-portable'
              _RuntimeIdentifier: ''
              _BuildArchitecture: 'x64'
              _DropSuffix: ''
            Build_Fedora_27_Debug_x64:
              _BuildConfig: Debug
              _DockerParameter: '--docker fedora.27'
              _LinuxPortable: '--linux-portable'
              _RuntimeIdentifier: ''
              _BuildArchitecture: 'x64'
              _DropSuffix: ''
            Build_OpenSUSE_42_3_Debug_x64:
              _BuildConfig: Debug
              _DockerParameter: '--docker opensuse.42.3'
              _LinuxPortable: '--linux-portable'
              _RuntimeIdentifier: ''
              _BuildArchitecture: 'x64'
              _DropSuffix: ''
            Build_CentOS_7_1_Debug_x64:
              _BuildConfig: Debug
              _DockerParameter: '--docker centos'
              _LinuxPortable: ''
              _RuntimeIdentifier: ''
              _BuildArchitecture: 'x64'
              _DropSuffix: ''
            Build_Rhel_7_2_Release_x64:
              _BuildConfig: Release
              _DockerParameter: '--docker rhel'
              _LinuxPortable: ''
              _RuntimeIdentifier: ''
              _BuildArchitecture: 'x64'
              _DropSuffix: ''
            Build_Linux_musl_Debug_x64:
              _BuildConfig: Debug
              _DockerParameter: '--docker alpine.3.6'
              _LinuxPortable: ''
              _RuntimeIdentifier: '--runtime-id linux-musl-x64'
              _BuildArchitecture: 'x64'
              _DropSuffix: ''
            Build_LinuxPortable_Release_x64:
              _BuildConfig: Release
              _DockerParameter: ''
              _LinuxPortable: '--linux-portable'
              _RuntimeIdentifier: ''
              _BuildArchitecture: 'x64'
              _DropSuffix: ''
            Build_LinuxPortable_NoSuffix_Release_x64:
              _BuildConfig: Release
              _DockerParameter: ''
              _LinuxPortable: '--linux-portable'
              _RuntimeIdentifier: ''
              _BuildArchitecture: 'x64'
              _DropSuffix: true

    - template: /eng/build.yml
      parameters:
        agentOs: Darwin
        pool:
          name: Hosted macOS
        timeoutInMinutes: 180
        strategy:
          matrix:
            Build_Release:
              _BuildConfig: Release

  - ${{ if and(ne(variables['System.TeamProject'], 'public'), notin(variables['Build.Reason'], 'PullRequest')) }}:
    - template: /eng/common/templates/job/publish-build-assets.yml
      parameters:
        publishUsingPipelines: true
        dependsOn:
          - Windows_NT
        queue:
          name: Hosted VS2017

- ${{ if and(ne(variables['System.TeamProject'], 'public'), notin(variables['Build.Reason'], 'PullRequest')) }}:
  - template: /eng/common/templates/post-build/post-build.yml
    parameters:
      enableSymbolValidation: false
      SDLValidationParameters:
        enable: true
        params: ' -SourceToolsList @("policheck","credscan")
        -TsaInstanceURL $(_TsaInstanceURL)
        -TsaProjectName $(_TsaProjectName)
        -TsaNotificationEmail $(_TsaNotificationEmail)
        -TsaCodebaseAdmin $(_TsaCodebaseAdmin)
        -TsaBugAreaPath $(_TsaBugAreaPath)
        -TsaIterationPath $(_TsaIterationPath)
        -TsaRepositoryName "dotnet-cli"
        -TsaCodebaseName "dotnet-cli"
        -TsaPublish $True'
