<?xml version="1.0" encoding="utf-8"?>
<Project ToolsVersion="14.0" DefaultTargets="Layout" xmlns="http://schemas.microsoft.com/developer/msbuild/2003">
  <Import Project="test/ProjectsToTest.props" />
  <Import Project="test/TestPackageProjects.props" />

  <Target Name="PrepareTests"
          DependsOnTargets="Prepare">

    <PropertyGroup>
      <TestPackageBuildVersionSuffix>$(CommitCount)</TestPackageBuildVersionSuffix>
      <TestPackagesDir>$(BaseOutputDirectory)/tests/packages</TestPackagesDir>
      <TestDirectory>$(RepoRoot)/test</TestDirectory>
    </PropertyGroup>    

  </Target>

  <Target Name="Test" 
          DependsOnTargets="PrepareTests;
                            SetupTests;
                            RestoreTests;
                            BuildTests;
                            RunTests;" />

  <Target Name="SetupTests"
          DependsOnTargets="SetupTestProjects;" />

  <Target Name="SetupTestProjects"
          DependsOnTargets="SetupTestPackageProjectData;
                            RestoreTestAssetProjects;
                            RestoreDesktopTestAssetProjects;
                            BuildTestAssetProjects;
                            BuildDesktopTestAssetProjects;" />

  <Target Name="SetupTestPackages" 
          DependsOnTargets="RestoreTestAssetPackages;
                            SetupTestPackageProjectData"
          Outputs="%(TestPackageProject.Identity)">
    <PropertyGroup>
      <VersionSuffixOption></VersionSuffixOption>
      <VersionSuffixOption Condition="'%(TestPackageProject.VersionSuffix)' != ''">--version-suffix %(TestPackageProject.VersionSuffix)</VersionSuffixOption>
    </PropertyGroup>
    <Exec Command="dotnet pack %(TestPackageProject.FullPath) --output $(TestPackagesDir) $(VersionSuffixOption)" />
  </Target>

  <Target Name="RestoreTestAssetPackages" 
          DependsOnTargets="PrepareTests;
                            SetupRestoreTestAssetPackagesInputs;" 
          Inputs="@(RestoreTestAssetPackagesInputs)"
          Outputs="@(RestoreTestAssetPackagesInputs->'%(RelativeDir)/project.lock.json')">
    <Exec Command="dotnet restore $(RepoRoot)/TestAssets/TestPackages/" />
  </Target>

  <Target Name="SetupRestoreTestAssetPackagesInputs">
    <ItemGroup>
      <RestoreTestAssetPackagesInputs Include="$(RepoRoot)/TestAssets/TestPackages/**/project.json" />
    </ItemGroup>
  </Target>

  <Target Name="RestoreTestAssetProjects"
          DependsOnTargets="SetupTestPackages;
                            SetupRestoreTestAssetProjectsInputs;"
          Inputs="@(RestoreTestAssetProjectsInputs)"
          Outputs="@(RestoreTestAssetProjectsInputs->'%(RelativeDir)/project.lock.json')">
    <Exec Command="dotnet restore $(RepoRoot)/TestAssets/TestProjects/ --fallbacksource $(TestPackagesDir)" />
  </Target>

  <Target Name="SetupRestoreTestAssetProjectsInputs" >
    <ItemGroup>
      <RestoreTestAssetProjectsInputs Include="$(RepoRoot)/TestAssets/TestProjects/**/project.json" />
    </ItemGroup>
  </Target>

  <Target Name="CleanTestAssetProjectsLockFiles" >
    <ItemGroup>
      <TestAssetProjectsLockFiles Include="$(RepoRoot)/TestAssets/TestProjects/**/project.lock.json" />
    </ItemGroup>
    <Delete Files="@(TestAssetProjectsLockFiles)" /> 
  </Target>

  <Target Name="RestoreDesktopTestAssetProjects"
          DependsOnTargets="SetupTestPackages;
                            SetupRestoreDesktopTestAssetProjectsInputs;"
          Inputs="@(RestoreDesktopTestAssetProjectsInputs)"
          Outputs="@(RestoreDesktopTestAssetProjectsInputs->'%(RelativeDir)/project.lock.json')">
    <Exec Command="dotnet restore $(RepoRoot)/TestAssets/DesktopTestProjects/ --fallbacksource $(TestPackagesDir)" />
  </Target>

  <Target Name="SetupRestoreDesktopTestAssetProjectsInputs">
    <ItemGroup>
      <RestoreDesktopTestAssetProjectsInputs Include="$(RepoRoot)/TestAssets/TestProjects/**/project.json" />
    </ItemGroup>
  </Target>

  <Target Name="BuildTestAssetProjects" >
    <ItemGroup>
      <NoAutoBuildTestAssets Include="$(RepoRoot)/TestAssets/TestProjects/**/.noautobuild" />
      <NoAutoBuildTestAssetProjects Include="%(NoAutoBuildTestAssets.RelativeDir)/project.json" />
      <BuildableTestAssetProjects Include="$(RepoRoot)/TestAssets/TestProjects/**/project.json" Exclude="@(NoAutoBuildTestAssetProjects)" />
    </ItemGroup>

    <Message Text="Skipping projects with .noautobuild files:" />
    <Message Text="%(NoAutoBuildTestAssetProjects.FullPath)" />

    <Exec Command="dotnet build %(BuildableTestAssetProjects.FullPath) --framework netcoreapp1.0" WorkingDirectory="%(BuildableTestAssetProjects.RelativeDir)" />
  </Target>

  <Target Name="BuildDesktopTestAssetProjects" Condition=" '$(IsDesktopAvailable)' == 'True' " >
    <ItemGroup>
      <NoAutoBuildDesktopTestAssets Include="$(RepoRoot)/TestAssets/TestProjects/**/.noautobuild" />
      <NoAutoBuildDesktopTestAssetProjects Include="%(NoAutoBuildDesktopTestAssets.RelativeDir)/project.json" />
      <BuildableDesktopTestAssetProjects Include="$(RepoRoot)/TestAssets/DesktopTestProjects/**/project.json" Exclude="@(NoAutoBuildTestAssetProjects)" />
    </ItemGroup>

    <Message Text="Skipping projects with .noautobuild files:" />
    <Message Text="%(NoAutoBuildTestAssetProjects.FullPath)" />

    <Exec Command="dotnet build %(BuildableTestAssetProjects.FullPath) --framework net451" WorkingDirectory="%(BuildableTestAssetProjects.RelativeDir)" />
  </Target>

  <Target Name="RestoreTests"
          DependsOnTargets="SetupRestoreTestsInputs;"
          Inputs="@(RestoreTestsInputs)"
          Outputs="@(RestoreTestsInputs->'%(RelativeDir)/project.lock.json')">
    <Exec Command="dotnet restore $(TestDirectory) --fallbacksource $(TestPackagesDir)" WorkingDirectory="$(TestDirectory)" />
  </Target>

  <Target Name="SetupRestoreTestsInputs"
          DependsOnTargets="PrepareTests;" >
    <ItemGroup>
      <RestoreTestsInputs Include="$(TestDirectory)/**/project.json" />
    </ItemGroup>
  </Target>

  <Target Name="BuildTests" 
          DependsOnTargets="PrepareTests;">
    <Exec Command="dotnet build --configuration $(Configuration)" WorkingDirectory="$(TestDirectory)/%(ProjectsToTest.Identity)/" />
  </Target>

  <Target Name="RunTests" >
    <Message Text="RunTests" />
  </Target>

  <Target Name="ValidateDependencies" >
    <Message Text="ValidateDependencies" />
  </Target>
</Project>